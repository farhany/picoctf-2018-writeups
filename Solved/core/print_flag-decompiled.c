//
// This file was generated by the Retargetable Decompiler
// Website: https://retdec.com
// Copyright (c) 2018 Retargetable Decompiler <info@retdec.com>
//

#include <fcntl.h>
#include <stdbool.h>
#include <stdint.h>
#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>

// ------------------- Function Prototypes --------------------

void load_flag(char * buf);
void load_garbage(char * buf);
void load_strings(void);
void print_flag(void);

// --------------------- Global Variables ---------------------

int32_t g1 = 0; // esp
char * hex_chars = "\xeb\x88\x04\x08";
int32_t strs = 0;

// ------------------------ Functions -------------------------

// From module:   ./print_flag.c
// Address range: 0x80485bb - 0x804869c
// Line range:    28 - 51
void load_strings(void) {
    // 0x80485bb
    int32_t v1; // bp-44
    int32_t v2 = &v1; // 0x80485be
    char * env_val = getenv("SEED_ENV"); // 0x80485c9
    int32_t size = (int32_t)env_val; // 0x80485c9
    if (env_val == NULL) {
        // 0x80485da
        puts("Unable to seed prng, exiting");
        exit(1);
        // UNREACHABLE
    }
    // 0x80485f4
    srand(strtoul(env_val, NULL, 16));
    *(int32_t *)(v2 - 12) = 1;
    *(int32_t *)(v2 - 16) = 33;
    int32_t * mem = calloc(0, size); // 0x804862e44
    int32_t status = (int32_t)mem; // 0x804862e45
    if (mem == NULL) {
        // 0x804863f
        *(int32_t *)g1 = (int32_t)"failed to allocate buffer, exiting";
        puts((char *)mem);
        *(int32_t *)g1 = 1;
        exit(status);
        // UNREACHABLE
    }
    char * v3 = (char *)mem; // 0x804863654
    int32_t v4 = status; // 0x804862e52
    int32_t v5 = 0;
    int32_t * mem2; // 0x804862e
    int32_t status2; // 0x804862e
    while (true) {
        // 0x8048659
        *(int32_t *)g1 = v4;
        if (v5 != 1337) {
            // 0x8048671
            load_garbage(v3);
            // branch -> 0x804867f
        } else {
            // 0x8048661
            load_flag(v3);
            // branch -> 0x804867f
        }
        // 0x804867f
        *(int32_t *)(4 * v5 + (int32_t)&strs) = v4;
        int32_t nmemb = v5 + 1; // 0x804868c
        if (nmemb >= 0x2710) {
            // 0x8048699
            return;
        }
        // 0x804867f
        *(int32_t *)(g1 - 12) = 1;
        *(int32_t *)(g1 - 16) = 33;
        mem2 = calloc(nmemb, size);
        status2 = (int32_t)mem2;
        if (mem2 == NULL) {
            // break -> 0x804863f
            break;
        }
        v3 = (char *)mem2;
        v4 = status2;
        v5 = nmemb;
        // continue -> 0x8048659
    }
    // 0x804863f
    *(int32_t *)g1 = (int32_t)"failed to allocate buffer, exiting";
    puts((char *)mem2);
    *(int32_t *)g1 = 1;
    exit(status2);
    // UNREACHABLE
}

// From module:   ./print_flag.c
// Address range: 0x804869c - 0x80486f8
// Line range:    56 - 62
void load_garbage(char * buf) {
    int32_t v1 = (int32_t)buf; // 0x80486ad
    // branch -> 0x80486ad
    for (uint32_t i = 0; i < 32; i++) {
        char v2 = *(char *)(rand() % 16 + *(int32_t *)&hex_chars); // 0x80486d6
        *(char *)(i + v1) = v2;
        // PHI copies at the loop end
        // loop 0x80486ad end
    }
    // 0x80486e5
    *(char *)(v1 + 32) = 0;
}

// From module:   ./print_flag.c
// Address range: 0x80486f8 - 0x80487c1
// Line range:    65 - 87
void load_flag(char * buf) {
    int32_t fd = open("./flag", O_RDONLY); // 0x8048708
    if (fd < 0) {
        // 0x8048719
        puts("Failed to open flag file, exiting");
        exit(1);
        // UNREACHABLE
    }
    // 0x8048733
    int32_t flag_idx; // bp-28
    int32_t v1 = &flag_idx; // 0x80486fb
    flag_idx = 0;
    int32_t v2 = (int32_t)buf; // 0x8048750
    int32_t v3 = 0; // 0x8048753
    int32_t fd2 = 0;
    // branch -> 0x8048748
    int32_t v4; // 0x8048774
    while (true) {
        // 0x8048748
        *(int32_t *)(v1 - 8) = 32 - v3;
        *(int32_t *)(v1 - 12) = v3 + v2;
        *(int32_t *)(v1 - 16) = fd;
        int32_t * buf2;
        int32_t v5 = read(fd2, &buf2, (int32_t)&buf2); // 0x8048760
        int32_t v6 = flag_idx; // 0x8048774
        if (v5 > 0) {
            // 0x804877d
            v4 = v6 + v5;
            flag_idx = v4;
            if (v4 >= 32) {
                // break -> 0x80487a3
                break;
            }
            v1 = g1 + 16;
            v3 = v4;
            fd2 = v5;
            // continue -> 0x8048748
            continue;
        } else {
            // 0x8048783
            if (v6 < 32) {
                // 0x8048789
                *(int32_t *)g1 = (int32_t)"Failed to read entire_flag, exiting";
                puts((char *)flag_idx);
                *(int32_t *)g1 = 1;
                exit(flag_idx);
                // UNREACHABLE
            }
        }
        // 0x80487a3
        *(char *)(v2 + 1 + v6) = 0;
        *(int32_t *)((int32_t)&strs + 0x14e4) = v2;
        return;
    }
    // 0x80487a3
    *(char *)(v2 + 1 + v4) = 0;
    *(int32_t *)((int32_t)&strs + 0x14e4) = v2;
}

// From module:   ./print_flag.c
// Address range: 0x80487c1 - 0x80487ec
// Line range:    90 - 93
void print_flag(void) {
    int32_t v1 = *(int32_t *)((int32_t)&strs + 0x14e4); // 0x80487d1
    printf("your flag is: picoCTF{%s}\n", (char *)v1);
}

// From module:   ./print_flag.c
// Address range: 0x80487ec - 0x8048815
// Line range:    96 - 99
int main(int argc, char ** argv) {
    // 0x80487ec
    load_strings();
    print_flag();
    return 0;
}

// --------------- Dynamically Linked Functions ---------------

// void * calloc(size_t nmemb, size_t size);
// void exit(int status);
// char * getenv(const char * name);
// int open(const char * file, int oflag, ...);
// int printf(const char * restrict format, ...);
// int puts(const char * s);
// int rand(void);
// ssize_t read(int fd, void * buf, size_t nbytes);
// void srand(unsigned int seed);
// unsigned long int strtoul(const char * restrict nptr, char ** restrict endptr, int base);

// --------------------- Meta-Information ---------------------

// Detected compiler/packer: gcc (5.4.0)
// Detected language: C
// Detected functions: 5
// Decompilation date: 2018-10-08 13:28:48
